set windows-shell := ["powershell.exe", "-NoLogo", "-Command"]
set shell := ["sh", "-c"]
set dotenv-load

# é»˜è®¤æ‰§è¡Œ listing
default:
    @just --list

# =================================================================
# ğŸ› ï¸ åˆå§‹åŒ–ä¸ç¯å¢ƒ (Setup)
# =================================================================

setup:
    @echo "ğŸ“¦ æ­£åœ¨åˆå§‹åŒ–ç¯å¢ƒ (Installing dependencies)..."
    # 1. æ£€æŸ¥ Docker (å…¼å®¹ PowerShell å’Œ Sh)
    @if (Get-Command docker -ErrorAction SilentlyContinue) { docker info > $null 2>&1; if ($LASTEXITCODE -ne 0) { echo "âš ï¸ Docker is NOT running!"; exit 1 } else { echo "âœ… Docker is running" } }
    # 2. å®‰è£…åç«¯ä¾èµ–
    uv sync
    # 3. å®‰è£…å‰ç«¯ä¾èµ–
    cd frontend; npm install
    # 4. å®‰è£… Git é’©å­
    pre-commit install
    @echo "ğŸ‰ ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ! è¯·è¿è¡Œ 'just dev' å¯åŠ¨é¡¹ç›®ã€‚"

# =================================================================
# ğŸš€ æ ¸å¿ƒå‘½ä»¤ (Core)
# =================================================================

# ğŸš€ å¯åŠ¨ï¼šä¸€é”®è·‘èµ·å‰åç«¯
dev:
    @echo "ğŸš€ æ­£åœ¨å¯åŠ¨å…¨æ ˆå¼€å‘ç¯å¢ƒ..."
    # 1. åå°å¯åŠ¨ Docker æ•°æ®åº“
    docker compose -f docker/docker-compose.yml up -d db
    # 2. å¹¶è¡Œå¯åŠ¨ï¼šå‰ç«¯(Vite/React) + åç«¯(FastAPI/Uvicorn)
    # æ³¨æ„ï¼šbackend ç›®å½•ä¸‹çš„ main:app
    npx concurrently -k -n "FRONT,BACK" -c "cyan,green" \
        "npm run dev --prefix frontend" \
        "uv run uvicorn src.{{ package_name }}.main:app --app-dir backend --host 0.0.0.0 --port 8000 --reload"

# ğŸ§ª æµ‹è¯•ï¼šè¿è¡Œåç«¯ pytest
test:
    @echo "ğŸ§ª æ­£åœ¨è¿è¡Œåç«¯æµ‹è¯•..."
    uv run pytest backend/tests

# ğŸ§¹ æ¸…ç†ï¼šåˆ æ‰ç¯å¢ƒå’Œä¾èµ–
# [ä¼˜åŒ–] ä½¿ç”¨ Python è¿›è¡Œè·¨å¹³å°åˆ é™¤ï¼Œé¿å… Shell/PowerShell è¯­æ³•å†²çª
clean:
    @echo "ğŸ§¹ æ­£åœ¨æ¸…ç†ç¯å¢ƒ..."
    uv clean
    uv run python -c "import shutil, os; targets=['.venv', 'frontend/node_modules']; [shutil.rmtree(t, ignore_errors=True) for t in targets]; print('âœ… Cleaned')"

# =================================================================
# ğŸ§¹ ä»£ç è´¨é‡ (Quality Assurance)
# =================================================================

# æ ¼å¼åŒ–ä»£ç  (åç«¯ Ruff + å‰ç«¯ Prettier)
fmt:
    uv run ruff format backend/src
    uv run ruff check --select I --fix backend/src
    cd frontend; npx prettier --write . --ignore-unknown

# ä»£ç æ£€æŸ¥ (ä¸è‡ªåŠ¨ä¿®å¤)
lint:
    uv run ruff check backend/src
    cd frontend; npm run lint

# æ›´æ–°æ‰€æœ‰ä¾èµ– (æ¯å‘¨ç»´æŠ¤ç”¨)
update:
    @echo "ğŸ”„ Updating dependencies..."
    uv lock --upgrade
    uv sync
    pre-commit autoupdate
    @echo "âœ… Dependencies updated!"

# =================================================================
# ğŸ—ï¸ æ—¥å¸¸å¼€å‘å·¥ä½œæµ (V2.0 Pro)
# æ³¨æ„: ä¸‹é¢çš„ raw æ˜¯ä¸ºäº†ä¿æŠ¤ just å˜é‡ä¸è¢« Copier è¯¯è§£æ
# =================================================================
{% raw %}

# [å¿«å­˜] æ–°å»ºæäº¤ (è‡ªåŠ¨æ ¼å¼åŒ– + æäº¤)
# ç”¨æ³•: just save "feat: add login api"
save message: fmt
    @echo "ğŸ’¾ [New] æ­£åœ¨å­˜æ¡£..."
    git add .
    git commit -m "{{message}}"

# [ä¿®æ­£] è¿½åŠ æäº¤ (åˆå¹¶åˆ°ä¸Šä¸€æ¬¡ commitï¼Œä¸äº§ç”Ÿæ–°è®°å½•)
# ç”¨æ³•: just amend
# åœºæ™¯: åˆšæ‰æäº¤äº†ï¼Œä½†å‘ç°æ¼æ”¹äº†ä¸€è¡Œä»£ç ï¼Œæˆ–è€… typo
amend: fmt
    @echo "ğŸ©¹ [Fix] æ­£åœ¨ä¿®æ­£ä¸Šä¸€æ¬¡æäº¤..."
    git add .
    git commit --amend --no-edit

# [å‘ç‰ˆ] å…¨é‡æ£€æŸ¥ + æ¨é€ (è´¨é‡å®ˆé—¨å‘˜)
# ç”¨æ³•: just ship
ship: lint test
    @echo "ğŸš¢ æ­£åœ¨å‘ç‰ˆ (Lint + Test + Push)..."
    git push
    @echo "âœ… ä»£ç å·²æ¨é€åˆ°äº‘ç«¯!"

# [æ•°æ®åº“] ç”Ÿæˆè¿ç§»è„šæœ¬ (å½“ä¿®æ”¹äº† models.py å)
# ç”¨æ³•: just db-gen "add user age column"
# [ä¼˜åŒ–] å…ˆ cd backend ç¡®ä¿èƒ½æ‰¾åˆ° alembic.ini
db-gen message:
    @echo "ğŸ˜ ç”Ÿæˆæ•°æ®åº“ç‰ˆæœ¬æ–‡ä»¶..."
    cd backend; uv run alembic revision --autogenerate -m "{{message}}"

# [æ•°æ®åº“] åº”ç”¨å˜æ›´ (å‡çº§æ•°æ®åº“åˆ°æœ€æ–°)
# [ä¼˜åŒ–] å…ˆ cd backend ç¡®ä¿èƒ½æ‰¾åˆ° alembic.ini
db-up:
    @echo "ğŸ˜ æ­£åœ¨å‡çº§æ•°æ®åº“ç»“æ„..."
    cd backend; uv run alembic upgrade head

# [æµ‹è¯•] ç›‘å¬æ¨¡å¼ (ä¿å­˜æ–‡ä»¶å³è¿è¡Œæµ‹è¯•)
# éœ€å®‰è£… pytest-watch (ptw)
test-watch:
    uv run ptw backend/tests

{% endraw %}
[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[project]
name = "{{ project_slug }}-workspace"
version = "0.1.0"
description = "Modern Monorepo managed by uv"
readme = "README.md"
requires-python = ">=3.12"
dependencies = [
    "{{ package_name }}",
]

# === 架构核心 (保留模版逻辑) ===
[tool.hatch.build.targets.wheel]
packages = ["src/{{ package_name }}"]

[tool.uv]
package = true

[tool.uv.workspace]
members = ["backend"]

[tool.uv.sources]
"{{ package_name }}" = { workspace = true }

# === 工具链配置 (融入黄金标准) ===

# --- 1. Typos 拼写检查 ---
[tool.typos.default]
locale = "en"
[tool.typos.default.extend-words]
# 常用白名单
crate = "crate"
nd = "nd"
str = "str"
ser = "ser"
out = "out"
[tool.typos.files]
extend-exclude = ["*.json", "*.lock", "uv.lock", "node_modules", ".venv", ".next", "dist", "build"]

# --- 2. TOML 格式化 ---
[tool.taplo]
include = ["pyproject.toml"]
exclude = ["uv.lock"]

# --- 3. Pyright 类型检查 ---
[tool.pyright]
typeCheckingMode = "standard"
venvPath = "."
venv = ".venv"
# 忽略前端和构建目录
exclude = ["**/node_modules", "**/__pycache__", ".venv", "build", "dist", "frontend"]

# --- 4. Pytest 测试配置 ---
[tool.pytest.ini_options]
minversion = "7.0"
addopts = "-ra -q --strict-markers --import-mode=importlib"
testpaths = ["backend/tests"]
pythonpath = ["backend/src"]
filterwarnings = [
    "error",
    "ignore::DeprecationWarning",
    "ignore::ResourceWarning",
]

# --- 5. Ruff 核心配置 (Copier 模版中只写通用规则) ---
[tool.ruff]
src = ["backend/src"]
line-length = 88
target-version = "py312"
exclude = [
    ".git", ".venv", "node_modules", ".next", "dist",
    "**/__pycache__"
]

[tool.ruff.format]
quote-style = "double"
indent-style = "space"

[tool.ruff.lint]
# 启用全套规则 (来自旧版黄金标准)
select = [
    "E", "W", "F", "I", "UP", "B", "SIM", "N", "C4", "A",
    "RUF", "T20", "S", "PT", "LOG", "ERA", "T10", "PGH", "TID",
    "G", "D", "FURB", "PERF", "TRY", "FLY",
    "TC", "NPY", "PD", "DTZ", "ICN", "PIE", "ASYNC", "FIX", "FA"
]
ignore = [
    "SIM105", "N806", "A003", "S311", "TRY003", "TRY300", "TRY400",
    "D100", "D101", "D102", "D103", "D104", "D105", "D106", "D107",
    "ISC001", "COM812", "RUF001", "RUF002", "RUF003", "FIX002",
    "TC001", "TC002", "TC003"
]

# [关键] 保护开发体验，防止自动删除未使用的变量
unfixable = ["F401", "F841"]

[tool.ruff.lint.isort]
combine-as-imports = true
force-sort-within-sections = true
section-order = ["future", "standard-library", "third-party", "first-party", "local-folder"]

[tool.ruff.lint.pydocstyle]
convention = "google"

# 针对特定文件的豁免
[tool.ruff.lint.per-file-ignores]
"**/*.ipynb" = ["E402", "B018", "T201", "ERA001", "PD901"]
"**/tests/*" = ["S101", "SLF001", "T201", "PT011", "ERA001", "TRY", "PLR", "D", "ANN"]
"**/__init__.py" = ["F401", "F403"]
